<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlgoTrade Pro | Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: { gray: { 850: '#1a1d24', 900: '#111318', 950: '#0b0c10' } }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0b0c10; color: #e5e7eb; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .glass { background: rgba(23, 25, 30, 0.6); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .positive { color: #10b981; }
        .negative { color: #ef4444; }
        .dot-pulse { animation: pulse 2s infinite; box-shadow: 0 0 12px #6366f1; }
        @keyframes float {
        0%, 100% { transform: translateY(0) translateX(0); }
        50% { transform: translateY(-40px) translateX(30px); }
    }
    @keyframes float-delay {
        0%, 100% { transform: translateY(0) translateX(0); }
        50% { transform: translateY(40px) translateX(-30px); }
    }
    @keyframes float-slow {
        0%, 100% { transform: translateY(0) rotate(0deg); }
        50% { transform: translateY(-60px) rotate(10deg); }
    }
    @keyframes float-reverse {
        0%, 100% { transform: translateX(0) translateY(0); }
        50% { transform: translateX(-50px) translateY(30px); }
    }
    @keyframes pulse-slow {
        0%, 100% { opacity: 0.4; }
        50% { opacity: 0.7; }
    }
    @keyframes twinkle {
        0%, 100% { opacity: 0; }
        50% { opacity: 1; }
    }

    .animate-float { animation: float 20s ease-in-out infinite; }
    .animate-float-delay { animation: float-delay 25s ease-in-out infinite; }
    .animate-float-slow { animation: float-slow 30s ease-in-out infinite; }
    .animate-float-reverse { animation: float-reverse 22s ease-in-out infinite; }
    .animate-pulse-slow { animation: pulse-slow 8s ease-in-out infinite; }
    .animate-twinkle { animation: twinkle 4s ease-in-out infinite; }
    
    /* Radial gradient (Tailwind doesn't have it by default) */
    .bg-gradient-radial {
        background: radial-gradient(circle at center, var(--tw-gradient-stops));
    }
        @keyframes ping {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.08); opacity: 0.9; }
        }
        .animate-ping { animation: ping 3s cubic-bezier(0, 0, 0.2, 1) infinite; }
        @keyframes glow {
            from { text-shadow: 0 0 10px rgba(167, 139, 250, 0.6); }
            to { text-shadow: 0 0 30px rgba(167, 139, 250, 0.9); }
        }
        .animate-glow { animation: glow 3s ease-in-out infinite alternate; }
        .animate-pulse-slow { animation: pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .glass-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6); }
    </style>
</head>
<body class="min-h-screen relative">

<!-- Background Effects - Fixed & Safe -->
<div class="fixed inset-0 -z-50 pointer-events-none overflow-hidden">
    <div class="absolute top-0 left-0 w-[500px] h-[500px] bg-indigo-500/20 rounded-full blur-[100px] animate-float"></div>
    <div class="absolute bottom-0 right-0 w-[600px] h-[600px] bg-purple-500/20 rounded-full blur-[110px] animate-float-delay"></div>
    <div class="absolute top-20 right-20 w-[400px] h-[400px] bg-pink-500/15 rounded-full blur-[100px] animate-float-slow"></div>
    <div class="absolute bottom-40 left-10 w-[450px] h-[450px] bg-cyan-500/15 rounded-full blur-[100px] animate-float-reverse"></div>
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] 
                bg-gradient-radial from-emerald-500/8 via-transparent to-transparent 
                rounded-full blur-[120px] animate-pulse-slow"></div>
</div>
    <div class="max-w-[1600px] mx-auto p-4 md:p-6 space-y-8">
        
    <!-- Header - Compact & Sleeker -->
<header class="relative glass rounded-2xl p-4 md:p-5 flex flex-col md:flex-row justify-between items-center gap-6 card-glow glass-hover 
               backdrop-blur-md bg-gray-900/40 border border-gray-800 z-10">    <!-- Left: Logo + Title -->
    <div class="flex items-center gap-6 w-full md:w-auto">
        <div class="relative inline-block flex-shrink-0">
            <img src="https://thumbs.dreamstime.com/b/vibrant-high-energy-visualization-financial-market-success-neon-green-line-shaped-like-arrow-follows-zigzag-path-upward-420494646.jpg"
                 alt="AlgoTrade Pro Logo"
                 class="w-16 h-16 rounded-2xl object-cover">
            <div class="absolute inset-0 rounded-2xl border-4 border-white/40 animate-ping opacity-70 pointer-events-none"></div>
        </div>
                <!-- Title and User Info -->
                <div class="text-center md:text-left">
                    <h1 class="text-3xl font-black text-white tracking-tighter">
                        AlgoTrade <span class="bg-gradient-to-r from-indigo-400 via-purple-400 to-pink-400 bg-clip-text text-transparent animate-glow">PRO</span>
                    </h1>
                    <p class="text-xs text-gray-500 font-mono uppercase tracking-widest">{{ user.username }} | ID: {{ user.id }}</p>
                </div>
    </div>
            <!-- Divider -->
            <div class="h-10 w-px bg-gradient-to-b from-transparent via-gray-700 to-transparent hidden md:block"></div>

            <!-- Market Status --->
        <div class="flex items-center gap-6 w-full md:w-auto justify-between md:justify-start">
            <div class="inline-flex items-center px-3 py-1.5 rounded-full bg-gray-800/70 border border-gray-700">
                <div id="status-dot" class="w-2 h-2 rounded-full mr-2 shadow-sm bg-red-500"></div> <!-- Closed: red, Open: emerald-500 -->
                <span id="status-text" class="text-[10px] font-bold uppercase tracking-wide text-red-400">
            Market Closed
        </span>
            </div>

                <!-- Kill Switch -->
            <div class="flex items-center bg-black/60 backdrop-blur-xl px-4 py-2 rounded-full border border-gray-800 shadow-xl transition-all hover:shadow-emerald-500/30">
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="killSwitch" class="sr-only peer" {% if account.is_live_trading_enabled %}checked{% endif %} onchange="toggleKillSwitch()">
                    <!-- Toggle Background -->
                    <div class="w-10 h-5 bg-gray-700 rounded-full peer 
                                peer-checked:bg-emerald-600 transition-all duration-300 
                                shadow-inner peer-checked:shadow-emerald-500/50"></div>
                    <!-- Toggle Knob -->
                    <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-gray-400 rounded-full transition-all duration-300 
                                peer-checked:translate-x-5 peer-checked:bg-white 
                                shadow-md peer-checked:shadow-white/70"></div>
                </label>
                    <div class="ml-3 flex flex-col leading-tight" id="statusLabel">
                    <span class="text-xs uppercase font-bold tracking-wider 
                    text-red-400 peer-checked:text-emerald-400 
                    drop-shadow-md peer-checked:drop-shadow-[0_0_8px_rgba(52,211,153,0.6)]">
                    {% if account.is_live_trading_enabled %}LIVE{% else %}HALTED{% endif %}
                    </span>
                    <span class="text-[8px] text-gray-600 font-mono uppercase">Master</span>
            </div>
            </div>

       <!-- Last Sync -->
                <div class="text-center hidden sm:block">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-900/30 to-purple-900/30 shadow-xl shadow-indigo-500/30 flex items-center justify-center mx-auto mb-1">
                        <svg class="w-5 h-5 text-indigo-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <p class="text-[9px] text-gray-500 uppercase tracking-wider">Last Sync</p>
                    <p id="last-sync-time" class="text-indigo-300 font-mono text-base font-bold drop-shadow">--:--:--</p>
                </div>

               <!-- Action Icons  -->
        <div class="flex gap-3">
            <a href="{% url 'credentials' %}" class="p-3 glass rounded-xl transition-all hover:shadow-xl hover:shadow-indigo-500/60 hover:scale-110" title="Settings">
                <svg class="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"
                    style="filter: drop-shadow(0 0 10px rgba(129,140,248,0.7));">
                    <path stroke-linecap="round" stroke-linejoin="round" 
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </a>
            <a href="{% url 'logout' %}" class="p-3 glass rounded-xl transition-all hover:shadow-xl hover:shadow-red-500/60 hover:scale-110" title="Logout">
                <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"
                    style="filter: drop-shadow(0 0 10px rgba(248,113,113,0.7));">
                    <path stroke-linecap="round" stroke-linejoin="round" 
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
            </a>
        </div>
        </div>
</header>

       <!-- Chartink Alerts -->
        <div class="glass rounded-3xl overflow-hidden card-glow glass-hover border-t-4 border-t-indigo-500/60">
            <div class="px-8 py-5 bg-gradient-to-r from-indigo-900/20 to-purple-900/10 border-b border-gray-800 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="w-3 h-3 rounded-full bg-indigo-400 dot-pulse"></div>
                    <h2 class="text-sm font-black text-white uppercase tracking-[0.3em]">Chartink Alerts</h2>
                </div>
                <span id="alert-counter" class="text-xs text-indigo-300 font-mono tracking-widest">0 Signals Cached</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="text-xs uppercase text-gray-500 tracking-widest border-b border-white/10">
                        <tr>
                            <th class="px-4 py-4 text-left">Scan</th>
                            <th class="px-4 py-4 text-left">Symbol</th>
                            <th class="px-4 py-4 text-left">Time</th>
                            <th class="px-4 py-4 text-left">Action</th>
                        </tr>
                    </thead>
                    <tbody id="alerts-container" class="divide-y divide-gray-800/50"></tbody>
                </table>
            </div>
        </div>

        <!-- P&L Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="glass rounded-3xl p-6 border-l-4 border-l-emerald-500/50">
                <p class="text-[10px] text-gray-500 font-bold uppercase mb-1 tracking-widest">Realized Today</p>
                <h2 id="realized-pnl" class="text-3xl font-mono font-bold text-white">â‚¹ 0.00</h2>
            </div>
            <div class="glass rounded-3xl p-6 border-l-4 border-l-indigo-500/50">
                <p class="text-[10px] text-gray-500 font-bold uppercase mb-1 tracking-widest">Unrealized MTM</p>
                <h2 id="unrealized-pnl" class="text-3xl font-mono font-bold text-white tracking-tighter">â‚¹ 0.00</h2>
            </div>
        </div>

        <!-- Market Movers -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Gainers -->
            <div class="glass rounded-2xl overflow-hidden border border-emerald-500/20 shadow-[0_0_50px_-12px_rgba(16,185,129,0.1)]">
                <div class="px-4 py-3 bg-emerald-500/10 border-b border-emerald-500/20 flex justify-between items-center">
                    <h3 class="text-xs font-black uppercase tracking-tighter text-emerald-400">Top Gainers</h3>
                </div>
                <table class="w-full text-left border-collapse">
                    <thead class="text-[9px] uppercase text-gray-500 font-black tracking-widest border-b border-white/5">
                        <tr>
                            <th class="px-4 py-3">Symbol</th>
                            <th class="px-2 py-3 text-right">LTP</th>
                            <th class="px-2 py-3 text-center">% Chg</th>
                            <th class="px-2 py-3 text-right">% > Low</th>
                            <th class="px-2 py-3 text-right">Vol</th>
                            <th class="px-4 py-3 text-right">Turnover (Cr)</th>
                            <th class="px-4 py-3 text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody id="gainers-body" class="divide-y divide-white/5"></tbody>
                </table>
            </div>

            <!-- Losers -->
            <div class="glass rounded-2xl overflow-hidden border border-red-500/20 shadow-[0_0_50px_-12px_rgba(239,68,68,0.1)]">
                <div class="px-4 py-3 bg-red-500/10 border-b border-red-500/20 flex justify-between items-center">
                    <h3 class="text-xs font-black uppercase tracking-tighter text-red-400">Top Losers</h3>
                </div>
                <table class="w-full text-left border-collapse">
                    <thead class="text-[9px] uppercase text-gray-500 font-black tracking-widest border-b border-white/5">
                        <tr>
                            <th class="px-4 py-3">Symbol</th>
                            <th class="px-2 py-3 text-right">LTP</th>
                            <th class="px-2 py-3 text-center">% Chg</th>
                            <th class="px-2 py-3 text-right">% < High</th>
                            <th class="px-2 py-3 text-right">Vol</th>
                            <th class="px-4 py-3 text-right">Turnover (Cr)</th>
                            <th class="px-4 py-3 text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody id="losers-body" class="divide-y divide-white/5"></tbody>
                </table>
            </div>
        </div>
            <!-- Toast Notification -->
        <div id="toast"
            class="fixed top-6 right-6 hidden z-50 px-6 py-4 rounded-xl
                    bg-emerald-500/10 text-emerald-400 border border-emerald-500/30
                    shadow-2xl backdrop-blur-xl text-sm font-bold">
            ðŸš€ Market is LIVE
        </div>

        <!-- Market-open-sound -->
        <audio id="market-open-sound">
            <source src="https://actions.google.com/sounds/v1/alarms/medium_bell_ring.ogg" type="audio/ogg">
        </audio>

        <!-- Chartink Alert Sound -->
        <audio id="chartink-alert-sound">
            <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
        </audio>

        <!-- Portfolio Positions -->
    <div class="glass rounded-3xl overflow-hidden card-glow glass-hover shadow-2xl">            
        <div class="p-5 border-b border-gray-800 bg-gray-950/40 flex justify-between items-center">
                <h3 class="text-xs font-bold text-white uppercase tracking-[0.2em]">Open Positions</h3>
                <span id="pos-badge" class="text-[10px] font-mono bg-indigo-500/10 text-indigo-400 px-3 py-1 rounded-full border border-indigo-500/20">0 Active</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-[11px] text-left text-gray-400 border-separate border-spacing-y-1 px-4">
                    <thead>
                        <tr class="text-[9px] uppercase text-gray-600 tracking-widest">
                            <th class="py-3 px-2">Symbol</th>
                            <th class="py-3 px-2">Side / Qty</th>
                            <th class="py-3 px-2 text-right">Entry</th>
                            <th class="py-3 px-2 text-right">LTP</th>
                            <th class="py-3 px-2 text-right">P&L</th>
                        </tr>
                    </thead>
                    <tbody id="positions-body">
                        <tr><td colspan="5" class="py-20 text-center text-gray-700 italic font-medium">No open trades.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Strategy Modal -->
    <div id="tradeModal" class="fixed inset-0 bg-black/95 backdrop-blur-xl hidden flex items-center justify-center z-50 p-4">
        <div class="glass rounded-[2rem] w-full max-w-sm overflow-hidden shadow-2xl border border-gray-800">
            <div class="p-8 border-b border-gray-800 bg-gradient-to-b from-gray-800/50 to-transparent">
                <h2 id="modal-symbol" class="text-3xl font-mono font-bold text-white tracking-tighter">SYMBOL</h2>
                <div id="modal-badge" class="mt-3 inline-block px-4 py-1.5 rounded-full text-[10px] font-black tracking-widest uppercase">BUY LADDER</div>
            </div>
            <div class="p-8 space-y-6">
                <div class="flex bg-gray-900/50 p-1 rounded-2xl border border-gray-800 shadow-inner">
                    <button id="btnCap" onclick="setEntryType('CAPITAL')" class="flex-1 py-3 text-[10px] font-black rounded-xl transition bg-indigo-600 text-white">CAPITAL</button>
                    <button id="btnQty" onclick="setEntryType('QUANTITY')" class="flex-1 py-3 text-[10px] font-black rounded-xl transition text-gray-500">QUANTITY</button>
                </div>
                <div class="space-y-6">
                    <div>
                        <label id="valueLabel" class="block text-[10px] text-gray-500 font-bold uppercase tracking-widest mb-3">Amount (â‚¹)</label>
                        <input type="number" id="trade-value" value="10000" class="w-full bg-black border border-gray-800 text-white p-4 rounded-2xl focus:border-indigo-500 outline-none font-mono text-xl shadow-inner">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-black/50 p-4 rounded-2xl border border-gray-800 text-center">
                            <label class="block text-[8px] text-gray-600 font-bold uppercase mb-1">Trail SL %</label>
                            <input type="number" id="trade-tsl" value="1.0" step="0.1" class="w-full bg-transparent text-white font-mono text-center outline-none text-lg">
                        </div>
                        <div class="bg-black/50 p-4 rounded-2xl border border-gray-800 text-center">
                            <label class="block text-[8px] text-gray-600 font-bold uppercase mb-1">Add %</label>
                            <input type="number" id="trade-add" value="1.0" step="0.1" class="w-full bg-transparent text-white font-mono text-center outline-none text-lg">
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 bg-black/40 flex gap-4 border-t border-gray-800">
                <button onclick="closeModal()" class="flex-1 py-4 text-gray-500 text-[10px] font-bold hover:text-white transition uppercase">Cancel</button>
                <button onclick="executeTrade()" class="flex-[2] py-4 bg-indigo-600 text-white rounded-2xl text-[11px] font-black uppercase tracking-[0.2em] shadow-lg hover:bg-indigo-500 transition">Confirm</button>
            </div>
        </div>
    </div>

    <script>
    let lastAlertTimestamp = 0;
    let marketFeed = [];
    let syncInterval = null;
    let countdownInterval = null;
    let marketOpenedToday = false;
    
    function nowIST() {
            return new Date(
                new Date().toLocaleString("en-US", { timeZone: "Asia/Kolkata" })
            );
        }
        function pad(n) {
            return n.toString().padStart(2, '0');
        }

    function isMarketOpenIST() {
        const now = nowIST();
        const h = now.getHours();
        const m = now.getMinutes();
        const s = now.getSeconds();
        // NSE timings: 9:15 AM â€“ 3:30 PM IST
        return (
            (h > 9 || (h === 9 && m >= 15)) &&
            (h < 15 || (h === 15 && m <= 30))
        );
    }
     function getNextMarketOpenTime() {
        const now = nowIST();
        let open = new Date();

        open.setHours(9, 15, 0, 0);
        // If today is weekend or market already opened â†’ next weekday
        if (
            now.getDay() === 0 || // Sunday
            now.getDay() === 6 || // Saturday
            now >= open
        ) {
            do {
                open.setDate(open.getDate() + 1);
            } while (open.getDay() === 0 || open.getDay() === 6);
        }
        return open;
    }

    function showToast() {
        const toast = document.getElementById('toast');
        const sound = document.getElementById('market-open-sound');

        toast.classList.remove('hidden');
        sound.play().catch(()=>{});

        setTimeout(() => toast.classList.add('hidden'), 6000);
    }

    function startCountdown() {
    clearInterval(countdownInterval);

    countdownInterval = setInterval(() => {
        const now = nowIST();
        const openTime = getNextMarketOpenTime();
        const diff = openTime - now;

        if (diff <= 0) {
            clearInterval(countdownInterval);
            updateMarketState();
            return;
        }

        const totalSeconds = Math.floor(diff / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        const text = document.getElementById('status-text');
        text.innerText = `OPENS IN ${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;

        // Keep countdown style consistent
        document.getElementById('status-dot').className = 'w-4 h-4 rounded-full bg-yellow-500 shadow-lg shadow-yellow-500/70 animate-ping';
        document.getElementById('status-glow').className = 'absolute inset-0 rounded-full shadow-2xl shadow-yellow-500/60 opacity-100 animate-pulse-slow';
        document.getElementById('status-border').className = 'absolute inset-0 rounded-full border-4 border-yellow-500/70 opacity-100';
        text.className = 'text-lg font-black tracking-widest uppercase text-yellow-300 drop-shadow-lg';
    }, 1000);
}

    function updateMarketState() {
    const dot = document.getElementById('status-dot');
    const text = document.getElementById('status-text');

    const open = isMarketOpenIST();

    if (open) {
        // MARKET LIVE - Green/Emerald Style
        text.innerText = 'MARKET LIVE ';                    // or 'LIVE' if you prefer
        text.className = 'text-xs font-bold uppercase tracking-wide text-emerald-400';

        dot.className = 'w-2 h-2 rounded-full mr-2 shadow-sm bg-emerald-500 animate-pulse'; // subtle pulse instead of ping for small size

        clearInterval(countdownInterval);

        if (!syncInterval) {
            sync();
            syncInterval = setInterval(sync, 5000);
        }

        if (!marketOpenedToday) {
            marketOpenedToday = true;
            showToast();
        }
    } else {
        // MARKET CLOSED or Countdown
        marketOpenedToday = false;

        if (syncInterval) {
            clearInterval(syncInterval);
            syncInterval = null;
        }

        if (!marketFeed.length) sync();

        const now = nowIST();
        const nextOpen = getNextMarketOpenTime();
        const diff = nextOpen - now;

        if (diff > 0 && diff < 24 * 60 * 60 * 1000) {
            // Opens soon â†’ Countdown active (you can update text dynamically in startCountdown if needed)
            startCountdown(); // assumes this function updates a separate countdown display

            text.innerText = 'Opens Soon';
            text.className = 'text-xs font-bold uppercase tracking-wide text-yellow-400';

            dot.className = 'w-2 h-2 rounded-full mr-2 shadow-sm bg-yellow-500 animate-pulse';
        } else {
            // Fully closed
            text.innerText = 'Closed';
            text.className = 'text-xs font-bold uppercase tracking-wide text-red-400';

            dot.className = 'w-2 h-2 rounded-full mr-2 shadow-sm bg-red-500';
        }
    }
}
/* ================= DATA FETCH  ================= */

        let sToken = null, sSymbol = null, sAction = 'BUY';
        let curEntryType = 'CAPITAL';
        let tradeLock = false;

        async function sync() {
            try {
                const [mRes, aRes] = await Promise.all([
                    fetch('/api/dashboard-data/').then(r => r.json()),
                    fetch('/api/get-alerts/').then(r => r.json())
                ]);

                if(mRes.status === 'success') {
                    document.getElementById('last-sync-time').innerText = new Date().toLocaleTimeString();
                    document.getElementById('realized-pnl').innerText = `â‚¹ ${parseFloat(mRes.realized_pnl || 0).toFixed(2)}`;
                    const upnl = document.getElementById('unrealized-pnl');
                    const val = parseFloat(mRes.unrealized_pnl || 0);
                    upnl.innerText = `â‚¹ ${val.toFixed(2)}`;
                    upnl.className = `text-3xl font-mono font-bold tracking-tighter ${val >= 0 ? 'positive' : 'negative'}`;

                    marketFeed = [...(mRes.gainers || []), ...(mRes.losers || [])];
                    renderMovers('gainers-body', mRes.gainers || [], 'BUY');
                    renderMovers('losers-body', mRes.losers || [], 'SELL');
                    renderPositions(mRes.positions || []);
                }

                if(aRes.status === 'success') renderSignals(aRes.alerts || []);
            } catch(e) { console.error("Sync Error:", e); }
        }
        // Check market status every 30 seconds
    setInterval(updateMarketState, 30000);
    // Initial check on page load
    updateMarketState();

   function renderSignals(alerts) {
    const container = document.getElementById('alerts-container');
    document.getElementById('alert-counter').innerText =
        `${alerts.length} ALERTS CACHED`;

    if (!alerts || alerts.length === 0) {
        container.innerHTML = `
            <tr>
              <td colspan="4" class="py-8 text-center text-gray-600 italic">
                Awaiting webhook payloads...
              </td>
            </tr>`;
        return;
    }

    // ðŸ”” sound only for newest alert
    const newest = alerts[0];
    if (newest.timestamp > lastAlertTimestamp) {
        lastAlertTimestamp = newest.timestamp;
        const sound = document.getElementById('chartink-alert-sound');
        sound.currentTime = 0;
        sound.play().catch(() => {});
    }

    let rows = [];

    alerts.forEach(alert => {
        alert.stocks.forEach(symbol => {
            rows.push(`
              <tr class="border-b border-white/5 hover:bg-white/[0.03] transition">
                <td class="px-3 py-2 text-indigo-400 font-bold text-[10px]">
                  ${alert.scan_name}
                </td>
                <td class="px-3 py-2 font-mono font-bold text-white">
                  ${symbol}
                </td>
                 <td class="px-2 py-1 font-mono text-gray-400 text-[10px] text-left">
                  ${alert.datetime}
                </td>
                <td class="px-3 py-2 text-left space-x-2">
                  <button onclick="openAlertModal('${symbol}', 'BUY')"
                class="px-4 py-0.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded text-[9px] font-black uppercase">
                BUY
            </button>
            <button onclick="openAlertModal('${symbol}', 'SELL')"
                class="px-4 py-0.5 bg-red-600 hover:bg-red-500 text-white rounded text-[9px] font-black uppercase">
                SELL
            </button>
                </td>
              </tr>
            `);
        });
    });

    container.innerHTML = rows.join('');
}


        function handleSignalTrade(sym, side) {
    const match = marketFeed.find(x => x.symbol === sym);
    if (!match) {
        alert(`${sym} not found in monitored watchlist`);
        return;
    }
    openModal(match.token, sym, side);
}


        function formatVol(v) {
            const num = parseInt(v || 0);
            if (num === 0) return "0";
            if (num >= 10000000) return (num / 10000000).toFixed(2) + ' Cr';
            if (num >= 100000) return (num / 100000).toFixed(2) + ' L';
            if (num >= 1000) return (num / 1000).toFixed(1) + ' K';
            return num.toString();
        }

        function renderMovers(id, items, action) {
            const container = document.getElementById(id);
            if (!items || items.length === 0) {
                container.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-700 italic text-[10px]">No Data Available</td></tr>';
                return;
            }

            container.innerHTML = items.map(s => {
                const isBuy = action === 'BUY';
                const ltp = parseFloat(s.ltp || 0);
                const pct = parseFloat(s.pct_change || 0);
                const vol = parseInt(s.volume || 0);
                const turnover = parseFloat(s.turnover || 0);
                
                // Logic for showing Recovery from Low OR Drop from High
                const metricValue = isBuy ? parseFloat(s.pct_from_low || 0) : parseFloat(s.pct_from_high || 0);
                const metricIcon = isBuy ? 'â–²' : 'â–¼';
                const metricColor = isBuy ? 'text-emerald-500/80' : 'text-red-500/80';
                
                const volDisplay = formatVol(vol);
                const turnoverCr = (turnover / 10000000).toFixed(2);

               return `
                <tr class="hover:bg-white/[0.02] transition-colors group">
                    <td class="px-4 py-3">
                        <div class="flex flex-col">
                            <span class="text-[11px] font-bold text-gray-200">${s.symbol || 'N/A'}</span>
                            ${s.is_fno ? '<span class="text-[7px] text-blue-400 font-black tracking-widest uppercase">F&O</span>' : ''}
                        </div>
                    </td>
                    <td class="px-2 py-3 text-right font-mono text-[11px] text-gray-300">â‚¹${ltp.toFixed(2)}</td>
                    <td class="px-2 py-3 text-center font-mono font-bold text-[11px] ${pct >= 0 ? 'text-emerald-400' : 'text-red-400'}">
                        ${pct.toFixed(2)}%
                    </td>
                    <td class="px-2 py-3 text-right font-mono text-[10px] ${metricColor}">
                        ${metricIcon} ${Math.abs(metricValue).toFixed(2)}%
                    </td>
                    <td class="px-2 py-3 text-right font-mono text-[10px] text-gray-400">
                        ${volDisplay}
                    </td>
                    <td class="px-4 py-3 text-right font-mono text-[10px] text-gray-500">
                        ${turnoverCr} Cr
                    </td>
                    <td class="px-4 py-3 text-right">
                        <button onclick="openModal('${s.token}', '${s.symbol}', '${action}')" 
                                class="px-3 py-1 rounded text-[9px] font-black uppercase transition-all shadow-lg 
                                ${isBuy ? 'bg-emerald-600 hover:bg-emerald-500' : 'bg-red-600 hover:bg-red-500'} text-white">
                            ${action}
                        </button>
                    </td>
                </tr>`;
            }).join('');
        }

        function renderPositions(pos) {
            const list = document.getElementById('positions-body');
            document.getElementById('pos-badge').innerText = `${pos.length} Active`;
            if(pos.length === 0) {
                list.innerHTML = '<tr><td colspan="5" class="py-20 text-center text-gray-700 italic">No open trades.</td></tr>';
                return;
            }
            list.innerHTML = pos.map(p => `
                <tr class="hover:bg-white/[0.03] transition border-b border-gray-900/50">
                    <td class="py-4 px-2 font-bold text-white">${p.symbol_name || p.id}</td>
                    <td class="py-4 px-2"><span class="px-2 py-0.5 rounded text-[9px] font-bold border border-gray-800">${p.side || 'BUY'}</span> <span class="ml-2 font-mono text-[10px]">${p.qty || '--'}</span></td>
                    <td class="py-4 px-2 text-right font-mono text-gray-500">${p.entry_price ? parseFloat(p.entry_price).toFixed(2) : '--'}</td>
                    <td class="py-4 px-2 text-right font-mono text-gray-200">â‚¹${parseFloat(p.ltp || 0).toFixed(2)}</td>
                    <td class="py-4 px-2 text-right font-mono font-bold ${parseFloat(p.pnl || 0) >= 0 ? 'positive' : 'negative'}">${parseFloat(p.pnl || 0) >= 0 ? '+' : ''}${parseFloat(p.pnl || 0).toFixed(2)}</td>
                </tr>
            `).join('');
        }

        function setEntryType(type) {
            curEntryType = type;
            const bC = document.getElementById('btnCap'), bQ = document.getElementById('btnQty'), l = document.getElementById('valueLabel'), i = document.getElementById('trade-value');
            if(type === 'CAPITAL') {
                bC.className = "flex-1 py-3 text-[10px] font-black rounded-xl bg-indigo-600 text-white shadow-lg";
                bQ.className = "flex-1 py-3 text-[10px] font-black rounded-xl text-gray-500";
                l.innerText = "Capital Allocation (â‚¹)"; i.value = 10000;
            } else {
                bQ.className = "flex-1 py-3 text-[10px] font-black rounded-xl bg-indigo-600 text-white shadow-lg";
                bC.className = "flex-1 py-3 text-[10px] font-black rounded-xl text-gray-500";
                l.innerText = "Per Trade Quantity(Qty)"; i.value = 50;
            }
        }

       function openModal(t, s, a) {
    const modal = document.getElementById('tradeModal');

    // ðŸ”¥ RESET VISUAL STATE (MOST IMPORTANT)
    modal.classList.remove('hidden');
    modal.style.opacity = 1;
    modal.style.transform = 'scale(1)';
    modal.style.display = 'flex';
    modal.style.pointerEvents = 'auto';

    // RESET DATA STATE
    sToken = t;
    sSymbol = s;
    sAction = a;

    document.getElementById('modal-symbol').innerText = s;

    const b = document.getElementById('modal-badge');
    b.innerText = `${a} LADDER`;
    b.className =
        `mt-3 inline-block px-4 py-1.5 rounded-full text-[10px] font-black uppercase ${
            a === 'BUY'
                ? 'bg-emerald-500/10 text-emerald-500 border border-emerald-500/20'
                : 'bg-red-500/10 text-red-500 border border-red-500/20'
        }`;
}


    function openAlertModal(symbol, side) {
            sToken = null;       
            sSymbol = symbol;
            sAction = side;

            document.getElementById('modal-symbol').innerText = symbol;

            const badge = document.getElementById('modal-badge');
            badge.innerText = `${side} LADDER`;
            badge.className =
                side === 'BUY'
                ? 'mt-3 inline-block px-4 py-1.5 rounded-full text-[10px] font-black uppercase bg-emerald-500/10 text-emerald-500 border border-emerald-500/20'
                : 'mt-3 inline-block px-4 py-1.5 rounded-full text-[10px] font-black uppercase bg-red-500/10 text-red-500 border border-red-500/20';

            // Smooth open
            const modal = document.getElementById('tradeModal');
            modal.classList.remove('hidden');
            modal.style.opacity = 0;
            modal.style.transform = 'scale(0.95)';

            setTimeout(() => {
                modal.style.transition = 'all 0.25s ease';
                modal.style.opacity = 1;
                modal.style.transform = 'scale(1)';
            }, 10);
        }

function resetTradeState() {
    sAction = null;
    sToken = null;
    sSymbol = null;
    curEntryType = "CAPITAL";
    tradeLock = false;
}


  function closeModal() {
    document.getElementById("tradeModal").classList.add("hidden");
    resetTradeState();   // ðŸ”¥ REQUIRED
}



async function executeTrade() {
    if (tradeLock) return;          // ðŸ”’ prevent double click
    tradeLock = true;

    const btn = document.querySelector(
        '#tradeModal button.bg-indigo-600'
    );

    const originalText = btn.innerText;
    btn.innerText = "EXECUTING...";
    btn.style.pointerEvents = "none";

    try {
        const payload = {
            action: sAction,
            entry_type: curEntryType,
            entry_value: parseFloat(document.getElementById('trade-value').value),
            tsl: parseFloat(document.getElementById('trade-tsl').value),
            increase: parseFloat(document.getElementById('trade-add').value)
        };

        let url = '/api/trigger-ladder/';

        // ðŸ”µ CHARTINK ALERT CASE
        if (sToken === null) {
            payload.symbol = sSymbol;
            url = '/api/trigger-chartink-ladder/';
        }
        // ðŸŸ¢ TOP GAINERS / LOSERS CASE
        else {
            payload.token = sToken;
        }

        const res = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(payload)
        });

        const d = await res.json();

        if (d.status === 'success') {
            closeModal();      // ðŸ”¥ close instantly
            sync();            // async dashboard refresh
        } else {
            alert(d.message || 'Execution failed');
        }

    } catch (e) {
        console.error(e);
        alert("Execution Failed");
    } finally {
        tradeLock = false;
        btn.innerText = originalText;
        btn.style.pointerEvents = "auto";
    }
}


        function toggleKillSwitch() {
            fetch('/api/toggle-kill-switch/', { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } })
            .then(res => res.json()).then(data => {
                const l = document.getElementById('statusLabel');
                l.innerHTML = `<span class="text-[10px] uppercase font-black tracking-widest ${data.is_enabled ? 'text-emerald-500' : 'text-red-500'}">${data.is_enabled ? 'SYSTEM LIVE' : 'SYSTEM HALTED'}</span><span class="text-[8px] text-gray-500 font-mono uppercase">Master Controls</span>`;
            });
        }

        function getCookie(name) {
            let v = null; if (document.cookie && document.cookie !== '') {
                document.cookie.split(';').forEach(c => {
                    const i = c.trim(); if (i.substring(0, name.length + 1) === (name + '=')) v = decodeURIComponent(i.substring(name.length + 1));
                });
            } return v;
        }

</script>
</body>
</html>